{"version":3,"file":"static/js/95.68003008.chunk.js","mappings":"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","sources":["GameFeatures/Dungeon/Dungeon.js"],"sourcesContent":["import API_BASE from \"../../config\";\nimport axios from \"axios\";\nimport { changePlayerLocation } from \"../../Utils/GridManagement\";\nimport FloatingTextManager from \"../../UI/FloatingText\";\nimport { getLocalizedString } from \"../../Utils/stringLookup\";\nimport { tryAdvanceFTUEByTrigger } from \"../FTUE/FTUEutils\";\n\n// FTUE Cave dungeon grid ID (must match auth.js)\nconst FTUE_CAVE_GRID_ID = '695bd5b76545a9be8a36ee22';\n\nexport async function handleDungeonEntrance(\n  currentPlayer,\n  dungeonPhase,\n  setCurrentPlayer,\n  setGridId,\n  setGrid,\n  setTileTypes,\n  setResources,\n  updateStatus,\n  TILE_SIZE,\n  closeAllPanels,\n  bulkOperationContext,\n  masterResources,\n  strings = null,\n  masterTrophies = null,\n  transitionFadeControl = null,\n  resourcePosition = { x: 0, y: 0 }\n) {\n  try {\n    console.log(\"üö™ Handling dungeon entrance click, phase:\", dungeonPhase);\n    \n    // Check if dungeon is open\n    if (dungeonPhase !== 'open') {\n      console.log(\"üîí Dungeon is closed (phase: \" + dungeonPhase + \")\");\n      \n      // Show floating text at resource position\n      const message = strings?.[\"10201\"] || \"The dungeon is currently closed\";\n      FloatingTextManager.addFloatingText(message, resourcePosition.x, resourcePosition.y, TILE_SIZE);\n      updateStatus(message);\n      return;\n    }\n    \n    // Start fade transition for immersive teleportation\n    if (transitionFadeControl?.startTransition) {\n      console.log('üåë [DUNGEON] Starting fade transition');\n      transitionFadeControl.startTransition();\n    }\n    \n    console.log(\"‚úÖ Dungeon is open, preparing teleportation...\");\n    \n    // Get a random dungeon from the server and store source grid\n    try {\n      // First, store the current grid as the source\n      const sourceGridId = currentPlayer.location.g;\n      \n      const response = await axios.post(`${API_BASE}/api/enter-dungeon`, {\n        playerId: currentPlayer._id,\n        sourceGridId: sourceGridId,\n        frontierId: currentPlayer.frontierId\n      });\n      \n      if (!response.data.success) {\n        throw new Error(response.data.error || \"Failed to enter dungeon\");\n      }\n      \n      const dungeonGridId = response.data.dungeonGridId;\n      const dungeonEntryPosition = response.data.entryPosition; // Position of Dungeon Exit resource\n      const sourceGrid = response.data.sourceGridId; // Source grid returned from server\n      \n      console.log(\"üé≤ Entering dungeon:\", dungeonGridId, \"at position:\", dungeonEntryPosition, \"from source:\", sourceGrid);\n      \n      // Update the current player with the source grid\n      if (setCurrentPlayer) {\n        setCurrentPlayer(prev => ({\n          ...prev,\n          sourceGridBeforeDungeon: sourceGrid\n        }));\n      }\n      \n      const fromLocation = { ...currentPlayer.location };\n      const toLocation = {\n        x: dungeonEntryPosition.x,\n        y: dungeonEntryPosition.y,\n        g: dungeonGridId,\n        s: currentPlayer.settlementId,\n        f: currentPlayer.frontierId,\n        gtype: \"dungeon\",\n        gridCoord: null // Dungeons don't appear on the minimap\n      };\n    \n      console.log(\"üìç Teleporting to dungeon:\", toLocation);\n    \n      // Perform the teleportation\n      await changePlayerLocation(\n        currentPlayer,\n        fromLocation,\n        toLocation,\n        setCurrentPlayer,\n        setGridId,\n        setGrid,\n        setTileTypes,\n        setResources,\n        TILE_SIZE,\n        closeAllPanels,\n        updateStatus,\n        bulkOperationContext,\n        masterResources,\n        strings,\n        masterTrophies\n      );\n      \n      // Show success message\n      const successMessage = strings?.[\"10202\"] || \"You have entered the dungeon!\";\n      updateStatus(successMessage);\n      \n      // End fade transition\n      if (transitionFadeControl?.endTransition) {\n        transitionFadeControl.endTransition();\n      }\n      \n    } catch (error) {\n      throw error; // Re-throw to be caught by outer catch\n    }\n    \n  } catch (error) {\n    console.error(\"‚ùå Error entering dungeon:\", error);\n    \n    // Log more details about the error\n    if (error.response) {\n      console.error(\"Error response data:\", error.response.data);\n      console.error(\"Error response status:\", error.response.status);\n    }\n    \n    const errorMessage = error.response?.data?.error || \"Failed to enter dungeon\";\n    updateStatus(errorMessage);\n    \n    // End fade transition on error\n    if (transitionFadeControl?.endTransition) {\n      transitionFadeControl.endTransition();\n    }\n  }\n}\n\nexport async function handleDungeonExit(\n  currentPlayer,\n  setCurrentPlayer,\n  setGridId,\n  setGrid,\n  setTileTypes,\n  setResources,\n  updateStatus,\n  TILE_SIZE,\n  closeAllPanels,\n  bulkOperationContext,\n  masterResources,\n  strings = null,\n  masterTrophies = null,\n  transitionFadeControl = null\n) {\n  try {\n    console.log(\"üö™ Handling dungeon exit click\");\n    \n    // Start fade transition\n    if (transitionFadeControl?.startTransition) {\n      console.log('üåë [DUNGEON] Starting fade transition');\n      transitionFadeControl.startTransition();\n    }\n    \n    // Get exit information from server\n    const response = await axios.post(`${API_BASE}/api/exit-dungeon`, {\n      playerId: currentPlayer._id\n    });\n    \n    if (!response.data.success) {\n      throw new Error(response.data.error || \"Failed to exit dungeon\");\n    }\n    \n    const sourceGridId = response.data.sourceGridId;\n    const exitPosition = response.data.exitPosition; // Position of Dungeon Entrance resource\n    const settlementId = response.data.settlementId; // The settlement that contains the source grid\n\n    console.log(\"üè† Returning to grid:\", sourceGridId, \"at position:\", exitPosition);\n    console.log(\"üè† Using settlementId from server:\", settlementId);\n\n    const fromLocation = { ...currentPlayer.location };\n    const toLocation = {\n      x: exitPosition.x,\n      y: exitPosition.y,\n      g: sourceGridId,\n      s: settlementId,  // Use the grid's actual settlement, not player's home settlement\n      f: currentPlayer.frontierId,\n      gtype: response.data.gridType || \"valley\",\n      gridCoord: response.data.gridCoord // Restore minimap position\n    };\n    \n    console.log(\"üìç Teleporting back to:\", toLocation);\n    \n    // Perform the teleportation\n    await changePlayerLocation(\n      currentPlayer,\n      fromLocation,\n      toLocation,\n      setCurrentPlayer,\n      setGridId,\n      setGrid,\n      setTileTypes,\n      setResources,\n      TILE_SIZE,\n      closeAllPanels,\n      updateStatus,\n      bulkOperationContext,\n      masterResources,\n      strings,\n      masterTrophies\n    );\n    \n    // Clear the source grid from current player state\n    if (setCurrentPlayer) {\n      setCurrentPlayer(prev => ({\n        ...prev,\n        sourceGridBeforeDungeon: null\n      }));\n    }\n\n    // FTUE: Check if first-time user just exited the FTUE Cave and entered town\n    const wasInFTUECave = fromLocation.g === FTUE_CAVE_GRID_ID;\n    const enteredTown = toLocation.gtype === 'town';\n    if (currentPlayer?.firsttimeuser && wasInFTUECave && enteredTown) {\n      console.log('üéì First-time user exited FTUE Cave into town - triggering ExitedCave');\n      await tryAdvanceFTUEByTrigger('ExitedCave', currentPlayer._id, currentPlayer, setCurrentPlayer);\n    }\n\n    // Show success message\n    const successMessage = strings?.[\"10203\"] || \"You have exited the dungeon\";\n    updateStatus(successMessage);\n    \n    // End fade transition\n    if (transitionFadeControl?.endTransition) {\n      transitionFadeControl.endTransition();\n    }\n    \n  } catch (error) {\n    console.error(\"‚ùå Error exiting dungeon:\", error);\n    \n    // Log more details about the error\n    if (error.response) {\n      console.error(\"Error response data:\", error.response.data);\n      console.error(\"Error response status:\", error.response.status);\n      console.error(\"Error response headers:\", error.response.headers);\n    }\n    \n    updateStatus(\"Failed to exit dungeon\");\n    \n    // End fade transition on error\n    if (transitionFadeControl?.endTransition) {\n      transitionFadeControl.endTransition();\n    }\n  }\n}"],"names":["FTUE_CAVE_GRID_ID","async","handleDungeonEntrance","currentPlayer","dungeonPhase","setCurrentPlayer","setGridId","setGrid","setTileTypes","setResources","updateStatus","TILE_SIZE","closeAllPanels","bulkOperationContext","masterResources","strings","arguments","length","undefined","masterTrophies","transitionFadeControl","resourcePosition","x","y","console","log","message","FloatingTextManager","addFloatingText","startTransition","sourceGridId","location","g","response","axios","post","API_BASE","playerId","_id","frontierId","data","success","Error","error","dungeonGridId","dungeonEntryPosition","entryPosition","sourceGrid","prev","sourceGridBeforeDungeon","fromLocation","toLocation","s","settlementId","f","gtype","gridCoord","changePlayerLocation","endTransition","_error$response","_error$response$data","status","handleDungeonExit","exitPosition","gridType","wasInFTUECave","enteredTown","firsttimeuser","tryAdvanceFTUEByTrigger","headers"],"sourceRoot":""}